#{extends 'internalMain.html' /}
#{set title:'Simulador de revisional' /}


<form id="formSimulador" class="form-horizontal" onsubmit="calcular();">
	<fieldset>
		<div class="control-group"> 
				<label class="control-label" for="tipo_pessoa">Tipo de Cliente</label>
				<div class="controls">
				 	<div class="btn-group" name="tipo_pessoa" id="tipo_pessoa" data-toggle="buttons-radio" >
				  		<button type="button" name="tpPessoa" value="F" onClick="apresentaDivTipoFincto(this.value);" class="btn active" data-toggle="button">F√≠sico</button>
				  		<button type="button" name="tpPessoa" value="J" onClick="apresentaDivTipoFincto(this.value);" class="btn" data-toggle="button">Jur√≠dico</button>
					</div>
			    </div>
		    </div>  
		
		 	<div class="control-group" id="tpF"> 
			 	<label class="control-label" for="tipoFinanciamento">Tipo de Financiamento</label>
			 	<div id="tipoFinanciamentoFisica" class="controls">
				 	<div class="btn-group" id="tipo_financiamento_fisica"  data-toggle="buttons-radio" >
				  		<button type="button" value="V" class="btn active" onClick="showDivTipoVeiculo('V')" data-toggle="button">Ve√≠culo</button>
				  		<button type="button" value="C" class="btn" onClick="showDivTipoVeiculo('C')" data-toggle="button">Cheque Especial</button>
				  		<button type="button" value="P" class="btn" onClick="showDivTipoVeiculo('P')" data-toggle="button">Cr√©dito Pessoal</button>
				  		<button type="button" value="I" class="btn" onClick="showDivTipoVeiculo('I')" data-toggle="button">Cr√©dito Imobili√°rio</button>
				  		<button type="button" value="O" class="btn" onClick="showDivTipoVeiculo('O')" data-toggle="button">Outros</button>
					</div>	
				</div>
			</div>
			
		 	<div class="control-group" id="tpFinanciamentoVeiculo"> 
			 	<label class="control-label" for="tipoFinanciamento">Tipo de Veiculo</label>
			 	<div id="tiposVeiculo" class="controls">
				 	<div class="btn-group" id="tipo_veiculo"  data-toggle="buttons-radio" >
				  		<button type="button" value="MO" class="btn active" data-toggle="button">Moto</button>
				  		<button type="button" value="CR" class="btn" data-toggle="button">Carro</button>
				  		<button type="button" value="CM" class="btn" data-toggle="button">Caminhao</button>
				  		<button type="button" value="VO" class="btn" data-toggle="button">Outros</button>
					</div>	
				</div>
			</div>			
			
			<div class="control-group" id="tpJ">
			<label class="control-label" for="tipoFinanciamento">Tipo de Financiamento</label>
			 	<div id="tipoFinanciamentoJuridica"  class="controls">
				 	<div class="btn-group" data-toggle-name="tipo_financiamento_juridica" data-toggle="buttons-radio" >
				  		<button type="button" value="G" class="btn active" data-toggle="button">Capital de Giro</button>
				  		<button type="button" value="T" class="btn" data-toggle="button">Conta Garantida</button>
				  		<button type="button" value="A" class="btn" data-toggle="button">Aquisi√ß√£o de Bens</button>
				  		<button type="button" value="D" class="btn" data-toggle="button">Vendor</button>
				  		<button type="button" value="H" class="btn" data-toggle="button">Hot Money</button>
				  		<button type="button" value="L" class="btn" data-toggle="button">Desconto Duplic.</button>
				  		<button type="button" value="S" class="btn" data-toggle="button">Desc. Promis.</button>
					</div>	
				</div>	
			</div>
			
			<div class="control-group"> 
				<label class="control-label" for="vlrFinanciado">Valor Financiado</label>
				<div class="controls">
				    <input type="text" class="input-medium" id="vlrFinanciado" name="vlrFinanciado">
			    </div>
			</div>
			
			<div class="control-group"> 
				<label class="control-label" for="vlrParcelaAtual">Valor atual da parcela</label>
				<div class="controls">
				    <input type="text" class="input-medium" id="vlrParcelaAtual" name="vlrParcelaAtual">
			    </div>
			</div>
			
			<div class="control-group"> 
				<label class="control-label" for="qtdParcelas">Quantidade de parcelas</label>
				<div class="controls">
				    <input type="text" class="input-medium" id="qtdParcelas" name="qtdParcelas">
			    </div>
			</div>			

			<div class="control-group"> 
				<label class="control-label" for="qtdParcelasPagas">Quantidade de parcelas pagas</label>
				<div class="controls">
				    <input type="text" class="input-medium" id="qtdParcelasPagas" name="qtdParcelasPagas">
			    </div>
			</div>	
			
			<div class= "clear"> </div>
			<label class="checkbox">
		      <input type="checkbox" onClick="apresentaDivMes();"> Cliente sabe o m√™s do financiamento
		    </label>	 	 
		    
		    <div class= "clear"> </div>
			<div id="mesFinanciamento">
				  <div class="input-append date" id="dpMonths" data-date="102/2012" data-date-format="mm/yyyy" data-date-viewmode="years" data-date-minviewmode="months">
					<input class="span2" size="16" type="text" value="02/2012" readonly="">
					<span class="add-on"><i class="icon-calendar"></i></span>
				  </div>
		    </div>
		         
		    
		    <div class= "clear"> </div>
		    <div>
		    	<role="button" class="addButton btn btn-primary" data-toggle="modal" onClick="calcular()">Calcular</a>
		    </div>
		             
	</fieldset>
</form>
			
			
			<div id="divCalculos">
			
			#{form @Processo.carrega(), enctype:'multipart/form-data'}
		
				<input type="hidden" id="vlrFinanciadoProcesso" name="vlrFinanciadoProcesso">
				<input type="hidden" id="vlrParcelaAtualProcesso" name="vlrParcelaAtualProcesso">
				<input type="hidden" id="qtdParcelasProcesso" name="qtdParcelasProcesso">
				<input type="hidden" id="qtdParcelasPagasProcesso" name="qtdParcelasPagasProcesso">
				
				
				<span class="label label-success">Valor a ser cobrado do cliente</span>
				<br />
				<input type="text" id="txtCalcVlrCobrado" name="calcVlrCobrado" readOnly="readOnly">
				<div class= "clear"/>
							
				<span class="label label-important">Taxa de Juros Atual</span>
				<br />
				<input type="hidden" id="idCliente" name="idCliente" value="${idCliente}">
				<input type="text" id="txtCalcVlrJurosAtual" name="calcVlrJurosAtual" readonly="readonly">
				
				<div class= "clear"/>
				
				<span class="label label-success">Nova Taxas de Juros</span>
				<br />
				<input type="text" id="txtCalcVlrJurosNovo" name="calcVlrJurosNovo" readonly="readonly">
				<div class= "clear"/>
						
				<span class="label label-important">Valor Pago Indevido</span>
				<br />
				<input type="text" id="txtCalcVlrPagoIndevido" name="txtCalcVlrPagoIndevido" readonly="readonly">
				<div class= "clear"/>
				
				<span class="label label-success">Valor de Nova Parcela</span>
				<br />
				<input type="text" id="txtCalcVlrNovaParcela" name="txtCalcVlrNovaParcela" readonly="readonly">
				<div class= "clear"/>	
				
		    </div>  
			    #{ if (others.Util.getTipousuarioLogado() != "A") && idCliente != null}
			    	<input id="salvarProcessoBtn" class="btn btn-primary" type="submit" value="Novo Processo">
			    #{/if}	
			#{/}  
		        
	

<script type="text/javascript">

$(function(){
	$('#dpMonths').datepicker()
	.on('changeDate', function(ev){
		dataFinanciamento = ev.date;
  });
});

$(document).ready(function(){
	
	//Métodos para atualizar os campos que serão carregados no form do processo
	$("#vlrFinanciado").blur(function(){
		$("#vlrFinanciadoProcesso").val($("#vlrFinanciado").val());
	});

	$("#vlrParcelaAtual").blur(function(){
		$("#vlrParcelaAtualProcesso").val($("#vlrParcelaAtual").val());
	});	

	$("#qtdParcelas").blur(function(){
		$("#qtdParcelasProcesso").val($("#qtdParcelas").val());
	});	
	
	$("#qtdParcelasPagas").blur(function(){
		$("#qtdParcelasPagasProcesso").val($("#qtdParcelasPagas").val());
	});	
	
	
	
	
	var dataFinanciamento = new Date();
	$("#mesFinanciamento").hide();
	
	$("#qtdParcelas").mask("?9999", { placeholder: "" });
	$("#qtdParcelasPagas").mask("?9999", { placeholder: "" }); 
	
	//Default = PF
	$("#tipoFinanciamentoFisica").show();
	$("#tpF").show();
	$("#tipoFinanciamentoJuridica").hide();
	$("#tpJ").hide();
	
	$("#divCalculos").hide();
	
	$('#formSimulador').validate({
    rules: {
      vlrFinanciado: {
        money: true
      },
      vlrParcelaAtual: {
        money: true
      },
      qtdParcelas: {
        required: true
      },
      qtdParcelasPagas: {
        required: true
      }
    },
		highlight: function(element) {
			$(element).closest('.control-group').removeClass('success').addClass('error');
		},
		success: function(element) {
			element
			.text('OK!').addClass('valid')
			.closest('.control-group').removeClass('error').addClass('success');
		}
  });	
	
	// Configura√ß√£o para campos de Real.
	$("#vlrFinanciado").maskMoney({showSymbol:true, symbol:"R$", decimal:",", thousands:"."});
	$("#vlrParcelaAtual").maskMoney({showSymbol:true, symbol:"R$", decimal:",", thousands:"."});
	
});


function showDivTipoVeiculo(tpFinanciamento){
	if(tpFinanciamento == 'V'){ 
		   $('#tpFinanciamentoVeiculo').show(); 
		} else { 
		   $('#tpFinanciamentoVeiculo').hide(); 
		}
}
function calcular(){
	// Busco o tipo de pessoa selecionado
	var tpPessoa = $('#tipo_pessoa > button.active').val();
	var tpFinanciamento;
	var tpVeiculo;
	if(tpPessoa == "F"){
		tpFinanciamento = $('#tipo_financiamento_fisica > button.active').val();
		//Se tipo de financiamento for veiculo, verifico qual é o tipo de veiculo selecionado
		if(tpFinanciamento == 'V'){
			tpVeiculo = $('#tipo_veiculo > button.active').val();	
		}
	}
	else{
		tpFinanciamento = $('#tipo_financiamento_juridica > button.active').val();
	}
	
	if(typeof dataFinanciamento === 'undefined'){
		dataFinanciamento = new Date("October 13, 1910 11:13:00");
	}
	
	calcularAjax(tpPessoa, tpFinanciamento, tpVeiculo);
}
function calcularAjax(tpPessoa, tpFinanciamento, tpVeiculo){
	var listAction = #{jsRoute @Simulador.calcular(':vlrFinanciado', ':vlrParcelaAtual', ':qtdParcelas', ':qtdParcelasPagas', ':dataFinanciamento', ':tpPessoa', ':tpFinanciamento', ':tpVeiculo') /} 
  	$.ajax({
      url: listAction.url({vlrFinanciado: $("#vlrFinanciado").val().replace(".","").replace(",","."), vlrParcelaAtual: $("#vlrParcelaAtual").val().replace(".","").replace(",","."), qtdParcelas: $("#qtdParcelas").val(), qtdParcelasPagas: $("#qtdParcelasPagas").val(), dataFinanciamento: dataFinanciamento, tpPessoa: tpPessoa, tpFinanciamento: tpFinanciamento, tpVeiculo: tpVeiculo}),
      type: listAction.method,
      dataType: 'json',
      success : function(data) {
                $("#txtCalcVlrNovaParcela").val(data.vlrNovaParcela);
                $("#txtCalcVlrJurosNovo").val(data.vlrJurosNovo);
                $("#txtCalcVlrPagoIndevido").val(data.vlrPagoIndevido);
                $("#txtCalcVlrJurosAtual").val(data.vlrJurosAntigo);
                $("#txtCalcVlrCobrado").val(data.vlrCobrado);
           
           		$("#divCalculos").show();     
          }
    });
}

function apresentaDivMes(){
	if($("#mesFinanciamento").is(':visible'))
	{
		$("#mesFinanciamento").hide();
	}
	else
	{
		$("#mesFinanciamento").show();
	}
}

function apresentaDivTipoFincto(tipoPessoa){
	if(tipoPessoa != ""){
		if(tipoPessoa == "F"){
			$("#tipoFinanciamentoFisica").show();
			$("#tpF").show();
			$("#tipoFinanciamentoJuridica").hide();
			$("#tpJ").hide();
		}
		else{
			$("#tipoFinanciamentoJuridica").show();
			$("#tpJ").show();
			$("#tipoFinanciamentoFisica").hide();
			$("#tpF").hide();
		}
	}
}
</script>